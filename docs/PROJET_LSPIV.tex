% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
  \setmainfont[]{Arial}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={La raport interm√©diaire},
  pdfauthor={Antoine Vigui√©, Aymane Berriane, Christian Alvarez Leon, Meng Wang, Yu PENG},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[margin=1in]{geometry}



\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}


\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\usepackage{amsthm}

%‰ΩøÁî®‰∏≠ÊñáË¶Å‰ΩøÁî®Ëøô‰∏™ÂåÖ
\usepackage{ctex}

\usepackage{graphicx}
\graphicspath{{images/}} %Ë°®Á§∫ÂõæÁâáÂú®ÂΩìÂâçÁõÆÂΩï‰∏ãÁöÑimagesÁõÆÂΩï

%Â∞ÅÈù¢====================================================================================================================
\usepackage{pdfpages}
%=========================================================================================================================

%ÈáçÊñ∞ÂëΩÂêç=================================================================================================================

%\renewcommand{\bibname}{‰Ω†ÁöÑBIBLIOGRAPHY}
%\renewcommand{\abstractname}{‰Ω†ÁöÑABSTRACT}

\renewcommand{\refname}{R√âFERENCES}

%\renewcommand{\chaptername}{Chapitre}

%\usepackage{titlesec}

%\usepackage{lipsum}

%\titleformat{\chapter}[display]{\normalfont\bfseries}{}{0pt}{\Large}

%Ê†áÈ¢òÂëΩÂêç
\renewcommand{\contentsname}{SOMMAIRE}

%ÂõæÂëΩÂêç
\renewcommand{\figurename}{Figure}

%Âú®toc‰∏≠ÂåÖÂê´reference :https://tex.stackexchange.com/questions/57427/how-to-add-printindex-to-tableofcontents
\usepackage{makeidx}
\makeindex
\usepackage[nottoc]{tocbibind}

%toc Ê≤°ÊúâheadersÈ°µÁúâ
\addtocontents{toc}{\protect\thispagestyle{empty}}

%=========================================================================================================================


%È°µÁúâÈ°µËÑö==================================================================================================================

%\fancyhead[R]{\kaishu ‰∏≠ÂõΩÁüø‰∏öÂ§ßÂ≠¶~(Âåó‰∫¨) Á°ïÂ£´Â≠¶‰ΩçËÆ∫Êñá}
%\lhead{page \thepage\ of \pageref{LastPage}}
%\fancyhead[RO,LE]{\CJKfamily{hei} \bfseries \LaTeX{} ÊéíÁâàÁ≥ªÁªü}
%\fancyhead[LO,RE]{\CJKfamily{hei>} \bfseries \leftmark}
%\renewcommand{\headrule}{\hrule width\headwidth \vspace{1.5pt}\hrule width\headwidth} % ÊâÄË∞ìÁöÑÊñáÊ≠¶Á∫ø



%ÂÆö‰πâÈ°µÁúâÈ°µËÑö fancyhdr ÂåÖ
\usepackage{fancyhdr}

\pagestyle{fancy}

%ÈªòËÆ§Ê∏ÖÈô§ÊâÄÊúâÁöÑÈ°µÁúâÂíåÈ°µËÑöËÆæÁΩÆ
\fancyhf{} %Ê∏ÖÁ©∫È°µÁúâÈ°µËÑö ËøôÊòØ‰∏™Êõ¥Â∫ïÂ±ÇÁöÑÂëΩ‰ª§

%ËÆæÁΩÆÈ°µÁúâÈ´òÂ∫¶
\setlength\headheight{40pt}

%Â§öË°å
%\fancyhead[c]{From: Frank\\To: Michel}

% ‰ΩøÁî®tabular Â§öË°åÂØπÈΩê
% \rhead{
    % \begin{tabular}[b]{l@{}}
        % Page: \thepage\\\today
    % \end{tabular}
    % }
\lhead{\includegraphics[height=30pt]{ecole.png}}
\rfoot{\thepage}

%È°µÁúâÊ®™Á∫ø
%\renewcommand\headrulewidth{0pt} %ÈöêËóèÈ°µÁúâÊ®™Á∫ø
\renewcommand{\headrule}{\hrule width\headwidth \vspace{1.5pt}\hrule width\headwidth} % ÊâÄË∞ìÁöÑÊñáÊ≠¶Á∫ø

%==========================================================================================================================

\makeatletter
\def\thm@space@setup{%
  \thm@preskip=8pt plus 2pt minus 4pt
  \thm@postskip=\thm@preskip
}
\makeatother

% ËÆ©urlËøûÊé•Âèò‰∏∫ËÑöÊ≥®
\renewcommand{\href}[2]{#2\footnote{\url{#1}}}

% ÊµÆÂä®

\usepackage{float}


\usepackage{float}
\ifluatex
  \usepackage{selnolig}  % disable illegal ligatures
\fi

%natbib ÈÄâÈ°π======================================================================================================

\usepackage[]{natbib}
\bibliographystyle{plainnat}



\title{La raport interm√©diaire}
\author{Antoine Vigui√©, Aymane Berriane, Christian Alvarez Leon, Meng Wang, Yu PENG}
\date{2021-02-28}

%==========================================================================================================================================

\begin{document}


%ÊèíÂÖ•Â∞ÅÈù¢=================================================================
\includepdf{images/COVERPAGE.pdf}
%=======================================================================

%ÊèíÂÖ•Ê†áÈ¢ò=================================================================
%%%\maketitle
%%=======================================================================

%Âä†Á©∫ÁôΩÈ°µ‰ΩÜÂèàheater
%\newpage
%\mbox{}
%\newpage



{
\setcounter{tocdepth}{2}
\tableofcontents
}


\newpage

\hypertarget{introduction}{%
\section*{Introduction}\label{introduction}}
\addcontentsline{toc}{section}{Introduction}

Dans cette annexe , on va pr√©sent une m√©thode de python qui a une fonctionnalit√© similaire au Fudda-LSPIV . Une petite rappel : La technique LSPIV (Large Scale Particle Image Velocimetry) permet de mesurer les vitesses de surface d'un √©coulement par analyse de s√©quence d'images. La m√©thode LSPIV compl√®te se compose g√©n√©ralement de trois parties
principales:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  la pr√©paration de l'image qui permet de corriger la distorsion optique , et faire l'ortho rectification.
\item
  le traitement PIV qui permet de calculer le champ de vitesse de surface.
\item
  l'analyse des donn√©e qui permet en d√©duit le d√©bit en utilisent le profil bathym√©trique d'une section en travers et la vitesse moyenn√©e de profondeur .
\end{enumerate}

Quand on utilisent le logiciel Fudda-LSPIV , Certain d'entre nous a rencontr√© des bug techniques ,Dans cette contexte , on a d√©cid√© d'utiliser Python Comme alternative. on s'int√©resse par python , parce que le python nous offrit des fonctionnalit√© qui n'est pas int√©gr√© dans le logiciel Fudda-LSPIV , par exemple pour corriger la distorsion optique, c'est pas int√©gr√© dans Le Fudda-LSPIV mais c'est un √©tape essentiel. Et d'ailleurs, python est plus puissant pour analyser et traiter les donn√©s .

On est surtout inspir√© par le rapport Flood wave monitoring using LSPIV de G.H. Gerritsen qui est publi√© dans Github , dans son rapport , il d√©cit un √©tude de LSPIV √† Chuo Kikuu, Dar es Salaam, Tanzania, Notre √©tude se base sur cette √©tude. Les donn√©es sont accessible sur Github.

\newpage

\hypertarget{ip}{%
\section*{la pr√©paration de l'image}\label{ip}}
\addcontentsline{toc}{section}{la pr√©paration de l'image}

La pr√©paration de l'image est n√©cessaire pour √™tre en mesure de mieux distinguer les motifs en mouvement de l'imagerie et de supprimer les effets de perspective de l'image. La manipulation d'image pour pr√©parer l'imagerie pour l'analyse LSPIV se composent de plusieurs √©tapes. Subs√©quemment, ces √©tapes sont:

\begin{enumerate}
\def\labelenumi{(\arabic{enumi})}
\item
  La correction de distorsion optique.
\item
  l'orthorectification.
\item
  La mise en niveau de gris et la correction du gamma et du contraste.
\end{enumerate}

Les deux premi√®res √©tapes
sont appliqu√©es pour garantir la pr√©sence de distances √©gales dans les images.
La troisi√®me √©tape est utilis√©e pour am√©liorer la distinction de la graine de
l'arri√®re-plan et donc s'assurer de la validation de similitude
processus est efficace.

Dans cette partie, on va utiliser la libraire de python Opencv3\citep{noauthor_opencv_2015} qui nous permette d'appliquer des options de manipulation d'images et le vid√©o. vous pouvez l'installer par cette ligne de commande.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pip install opencv}\OperatorTok{{-}}\NormalTok{python}
\end{Highlighting}
\end{Shaded}

On a aussi besoin d'autres libraires python numpy, pandas, math pour traiter des donn√©es . Et si vous voulez refaire cette √©tude sur vos ordinateurs, On vous conseille d'utiliser le python install√© de site Anaconda et jupyter notebook

\hypertarget{la-correction-de-distorsion-optique}{%
\subsection*{La correction de distorsion optique}\label{la-correction-de-distorsion-optique}}
\addcontentsline{toc}{subsection}{La correction de distorsion optique}

En raison de la la courbure des lentilles de l'appareil photo, les images peuvent √™tre d√©form√©es. Figure \ref{fig:flens} pr√©sente les deux types de distorsions des lentilles les plus fr√©quentes,la distorsion en barillet et la distorsion en coussinet \citep{fryer_lens_1986} , Ces distorsions g√©om√©triques sont li√©es √† des facteurs radiaux. Un troisi√®me type de distorsion est distorsion tangentielle, qui se produit lorsque les lentilles ne sont pas parall√®les au plan
image. Certaines cam√©ras sont capables de faire face √† ces distorsions
int√©rieurement. Cependant, la plupart du temps, une certaine quantit√© de post-traitement est
n√©cessaire pour ajuster les images.



\begin{figure}[H]
\includegraphics[width=1\linewidth,]{images/lens} \caption{Les differentes types de distortion. Du gauche √† la droit : la grille d'origine, la distorsion en barillet et la distorsion en coussinet.}\label{fig:flens}
\end{figure}

Les formules suivantes sont appliqu√©es pour supprimer la distortion radial (Voir √âquation\eqref{eq:corr1}) et la distorsion tangentielle (Voir √âquation\eqref{eq:corr2})

\begin{equation}
\begin{aligned}
  x_{corr} = x\left(1+k_1r^2+k_2r^4+k_3r^6\right)
  \\y_{corr} = y\left(1+k_1r^2+k_2r^4+k_3r^6\right)
\end{aligned}
 \label{eq:corr1}
\end{equation}

D'o√π \(ùë•\) et \(ùë¶\) sont les coordonn√©es d'origineÕæ \(x_{ùëêùëúùëüùëü}\) et
\(y_{ùëêùëúùëüùëü}\) sont les coordonn√©es corrig√©s. \(ùëü\) est la distance entre le
point \(\left(ùë•, ùë¶\right)\) et le centre de la distortion. \(ùëò_1\), \(ùëò_2\),
et \(ùëò_3\) sont les coefficients radiales. Pour la distortion en barillet et la distortion en coussinet , \(ùëò_1\) est respectivemen negative et positive. \(ùëò_2\) et \(ùëò_3\) sont n√©gligeables.

\begin{equation}
\begin{aligned}
   x_{corr} = x+\left[ 2 p_1 x y+ p_2\left( r^2+2x^2\right) \right]\\
  y_{corr} = y+\left[ p_1 \left(r^2+2 y^2\right)+ 2p_2xy\right]
\end{aligned}
 \label{eq:corr2}
\end{equation}

D'o√π \(ùëù_1\) et \(ùëù_2\) sont les coefficient de la distortion tangentielle. les diff√©rents coefficients sont souvent stock√©s dans un tableau:

\begin{equation}
C_{dis}=
\begin{bmatrix}
k_1 & k_2 & p_1 & p_2 & k_3
\end{bmatrix}
\end{equation}

√Ä part du coefficient de distorsion, pour pouvoir corriger l'imagerie, Une conversion entre les coordonn√©es de distorsion et la r√©solution de la cam√©ra est
fait. Pour cela, la formule est donn√©e dans l'√©quation \eqref{eq:corr3}

\begin{equation}
\begin{bmatrix}
x\\
y\\
w
\end{bmatrix}
= M_{con} \cdot
\begin{bmatrix}
x\\
y\\
z
\end{bmatrix}
\quad \text{d'o√π} \quad
M_{con} =
\begin{bmatrix}
f_x & 0 & c_x\\
0 & f_y & c_y\\
0 & 0 &1
\end{bmatrix}
\label{eq:corr3}
\end{equation}

D'o√π \([ùë•, ùë¶, ùë§]\) sont les coordonn√©es d'image homog√®ne 2D et \([x, y , z]\) sont les coordonn√©es de cam√©ra 3D . \(f_ùë•\) et \(ùëì_ùë¶\) sont les longueurs locales de la cam√©ra dans le sens \(ùë•\) et \(ùë¶\) ,en gen√©ral, ils sont identiques \(ùëê_ùë•\) et \(ùëê_ùë¶\) sont les coordinations de centre optique de la cam√©ra dans le sens \(ùë•\) et \(ùë¶\).

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{matplotlib inline}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ os}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ cv2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dir\_video }\OperatorTok{=} \StringTok{\textquotesingle{}Python/example\_video.mp4\textquotesingle{}}
\NormalTok{dir\_saves }\OperatorTok{=} \StringTok{\textquotesingle{}Python/frames\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if} \KeywordTok{not}\NormalTok{ os.path.exists(dir\_saves):}
\NormalTok{    os.mkdir(dir\_saves)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# d√©finition de correction de la distorsion }
\KeywordTok{def}\NormalTok{ lens\_corr(img, k1}\OperatorTok{={-}}\FloatTok{10.0e{-}6}\NormalTok{, c}\OperatorTok{=}\DecValTok{2}\NormalTok{, f}\OperatorTok{=}\FloatTok{8.0}\NormalTok{):}
 
    \CommentTok{\# d√©finition la caract√®re de l\textquotesingle{}image }
\NormalTok{    height, width, \_\_ }\OperatorTok{=}\NormalTok{ img.shape}

    \CommentTok{\# le vecteur de coefficient de distorsion}
\NormalTok{    dist }\OperatorTok{=}\NormalTok{ np.zeros((}\DecValTok{5}\NormalTok{,}\DecValTok{1}\NormalTok{),np.float64)}
\NormalTok{    dist[}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{] }\OperatorTok{=}\NormalTok{ k1}
    
    \CommentTok{\# la matrice du cam√©ra}
\NormalTok{    mtx }\OperatorTok{=}\NormalTok{ np.eye(}\DecValTok{3}\NormalTok{,dtype}\OperatorTok{=}\NormalTok{np.float32)}

\NormalTok{    mtx[}\DecValTok{0}\NormalTok{,}\DecValTok{2}\NormalTok{] }\OperatorTok{=}\NormalTok{ width}\OperatorTok{/}\NormalTok{c     }\CommentTok{\# centre x}
\NormalTok{    mtx[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{] }\OperatorTok{=}\NormalTok{ height}\OperatorTok{/}\NormalTok{c    }\CommentTok{\# centre y}
\NormalTok{    mtx[}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{] }\OperatorTok{=}\NormalTok{ f           }\CommentTok{\# la distance focale x}
\NormalTok{    mtx[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{] }\OperatorTok{=}\NormalTok{ f           }\CommentTok{\# la distance focale y}

    \CommentTok{\# la correction d\textquotesingle{}image par la distorsion}
\NormalTok{    corr\_img }\OperatorTok{=}\NormalTok{ cv2.undistort(img, mtx, dist)}

    \ControlFlowTok{return}\NormalTok{ corr\_img}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# pour localiser les GCPts dans les images:}
\CommentTok{\# importer la vid√©o et corriger la premi√®re image pour la distorsion de l\textquotesingle{}objectif}
\NormalTok{cap }\OperatorTok{=}\NormalTok{ cv2.VideoCapture(dir\_video)}
\ControlFlowTok{if}\NormalTok{ cap.isOpened():}
\NormalTok{    ret, img }\OperatorTok{=}\NormalTok{ cap.read()}
\NormalTok{    corr\_img }\OperatorTok{=}\NormalTok{ lens\_corr(img, k1}\OperatorTok{={-}}\FloatTok{10.0e{-}6}\NormalTok{, c}\OperatorTok{=}\DecValTok{2}\NormalTok{, f}\OperatorTok{=}\FloatTok{8.0}\NormalTok{)}
\NormalTok{cap.release()}

\CommentTok{\# afficher l\textquotesingle{}image corrig√©e et les emplacements des GCP}
\NormalTok{fig }\OperatorTok{=}\NormalTok{ plt.figure(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{14}\NormalTok{,}\DecValTok{5}\NormalTok{))}
\NormalTok{plt.subplots\_adjust(left}\OperatorTok{=}\DecValTok{0}\NormalTok{, bottom}\OperatorTok{=}\DecValTok{0}\NormalTok{, right}\OperatorTok{=}\DecValTok{1}\NormalTok{, top}\OperatorTok{=}\DecValTok{1}\NormalTok{, wspace}\OperatorTok{=}\FloatTok{0.1}\NormalTok{, hspace}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\CommentTok{\# [:,:,::{-}1] BGR =\textgreater{} RGB ; Dans opencv c\textquotesingle{}est BGR}
\NormalTok{plt.subplot(}\DecValTok{121}\NormalTok{)}
\NormalTok{plt.imshow(img[:,:,::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}AVANT\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.axis(}\StringTok{\textquotesingle{}off\textquotesingle{}}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (-0.5, 1919.5, 1079.5, -0.5)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.subplot(}\DecValTok{122}\NormalTok{)}
\NormalTok{plt.imshow(corr\_img[:,:,::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}APR√àS\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.axis(}\StringTok{\textquotesingle{}off\textquotesingle{}}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (-0.5, 1919.5, 1079.5, -0.5)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
\includegraphics[width=1\linewidth,]{PROJET_LSPIV_files/figure-latex/unnamed-chunk-8-1} \caption{La correction de distorsion optique}\label{fig:unnamed-chunk-8}
\end{figure}

\hypertarget{lorthorectification}{%
\subsection*{l'orthorectification}\label{lorthorectification}}
\addcontentsline{toc}{subsection}{l'orthorectification}

Pour supprimer les effets de la perspective de l'image ,( o√π les objets sont plus proches
de la cam√©ra semble √™tre plus grande dans l'image) ,l'orthorectification est appliqu√©e.
Lors de l'application d'orthorectification,le syst√®me de coordonn√©es de l'imagerie est transf√©r√© √† une syst√®me de coordonn√©e locale. Pour ce syst√®me de coordonn√©es locales, points de contr√¥le au sol (GCP) sont
mis en place √† c√¥t√© du flux sont utilis√©s. Pour l'orthorectification
processus pour √™tre aussi pr√©cis que possible, au moins quatre GCP sont n√©cessaires, si
les images sont captur√©es perpendiculairement au flux ou lorsque les GCP
sont plac√©s au m√™me niveau que le niveau de l'eau. Un minimum de six
GCP sont n√©cessaires lorsque les GCP ne sont pas plac√©s dans le m√™me plan que le
niveau d'eau. Sur la Figure \ref{fig:fortho} les diff√©rents sites de jaugeage
et les configurations sont affich√©es.



\begin{figure}[H]
\includegraphics[width=1\linewidth,]{images/ortho} \caption{Nombre de points de contr√¥le au sol (GCP) n√©cessaires dans diff√©rentes circonstances.(source: Flood wave monitoring using LSPIV)}\label{fig:fortho}
\end{figure}

Lors de l'utilisation de quatre GCP, les facteurs d'inversion \(ùëì_ùë•\) et \(ùëì_ùë¶\) sont
d√©termin√© en utilisant la formule indiqu√©e dans l'√©quation \eqref{eq:corr4}.

\begin{equation}
p_{loc}\left(x,y\right)=p_{img}\left(f_x\left(x,y\right), f_y\left(x,y\right)\right)
\label{eq:corr4}
\end{equation}

D'o√π \(ùëù_ {ùëëùë†ùë°} \left (ùë•, ùë¶, ùëß \right)\) est l'emplacement g√©ographique du
point de contr√¥le au sol dans le syst√®me de coordonn√©es local, g√©n√©ralement en m√©trique
units; \(ùëù_ {ùë†ùëüùëê} \left (ùë•, ùë¶ \right)\) est la coordonn√©e xy du sol
point de contr√¥le dans l'imagerie, g√©n√©ralement en pixels; et \(ùëì_ùë•\) et \(ùëì_ùë¶\) le
facteurs d'inversion.

Simultan√©ment √† ce processus, la r√©solution de l'image peut √™tre r√©gl√©e
en multipliant les coordonn√©es \(ùê∫ùê∂ùëÉ_ {ùëëùë†ùë°} \left (ùë•, ùë¶ \right)\) par les
pixels souhait√©s par coefficient de m√®tre.

Lorsque six (ou plus) GCP sont utilis√©s - parce que les coordonn√©es en trois dimensions
pour les GCP sont n√©cessaires - un mod√®le de st√©nop√© peut √™tre utilis√©. Cette m√©thode est
expliqu√© par \citep{jodeau_application_2008}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Emplacements des GCPs dans les images (pixels)}
\NormalTok{data\_from }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{: [}\DecValTok{992}\NormalTok{, }\DecValTok{1545}\NormalTok{, }\DecValTok{1773}\NormalTok{,  }\DecValTok{943}\NormalTok{],}
             \StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{: [}\DecValTok{366}\NormalTok{,  }\DecValTok{403}\NormalTok{,  }\DecValTok{773}\NormalTok{,  }\DecValTok{724}\NormalTok{]\}}
\NormalTok{df\_from }\OperatorTok{=}\NormalTok{ pd.DataFrame(data\_from)}


\NormalTok{fig }\OperatorTok{=}\NormalTok{ plt.figure(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{7}\NormalTok{,}\DecValTok{4}\NormalTok{))}
\NormalTok{plt.subplot(}\DecValTok{111}\NormalTok{)}
\NormalTok{plt.subplots\_adjust(left}\OperatorTok{=}\DecValTok{0}\NormalTok{, bottom}\OperatorTok{=}\DecValTok{0}\NormalTok{, right}\OperatorTok{=}\DecValTok{1}\NormalTok{, top}\OperatorTok{=}\DecValTok{1}\NormalTok{, wspace}\OperatorTok{=}\FloatTok{0.1}\NormalTok{, hspace}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.imshow(corr\_img[:,:,::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\NormalTok{plt.plot(df\_from.x, df\_from.y ,}\StringTok{\textquotesingle{}r.\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.axis(}\StringTok{\textquotesingle{}off\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (-0.5, 1919.5, 1079.5, -0.5)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
\includegraphics[width=1\linewidth,]{PROJET_LSPIV_files/figure-latex/unnamed-chunk-9-1} \caption{Les localisations des GRPS}\label{fig:unnamed-chunk-9}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Emplacements des GCPs dans le syst√®me de coordonn√©es local (m√®tres)}
\NormalTok{data\_to }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{: [ }\FloatTok{0.25}\NormalTok{, }\FloatTok{4.25}\NormalTok{, }\FloatTok{4.50}\NormalTok{, }\FloatTok{0.00}\NormalTok{],}
           \StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{: [ }\FloatTok{0.30}\NormalTok{, }\FloatTok{0.20}\NormalTok{, }\FloatTok{3.50}\NormalTok{, }\FloatTok{3.50}\NormalTok{]\}}
\NormalTok{df\_to }\OperatorTok{=}\NormalTok{ pd.DataFrame(data\_to)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ orthorect\_param(img, df\_from, df\_to, PPM}\OperatorTok{=}\DecValTok{100}\NormalTok{):}
    
    \CommentTok{\# d√©finir le valeur de float32(par point)}
\NormalTok{    pts1 }\OperatorTok{=}\NormalTok{ np.float32(df\_from.values)}
\NormalTok{    pts2 }\OperatorTok{=}\NormalTok{ np.float32(df\_to.values }\OperatorTok{*}\NormalTok{ PPM)}

    \CommentTok{\# d√©finir une matrice de transformation bas√©e sur les GCP}
\NormalTok{    M }\OperatorTok{=}\NormalTok{ cv2.getPerspectiveTransform(pts1, pts2)}

    \CommentTok{\# trouver les emplacements des coins d\textquotesingle{}image transform√©s}
\NormalTok{    height, width, \_\_ }\OperatorTok{=}\NormalTok{ img.shape}
\NormalTok{    C }\OperatorTok{=}\NormalTok{ np.array([[}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{],}
\NormalTok{                  [width, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{],}
\NormalTok{                  [}\DecValTok{0}\NormalTok{, height, }\DecValTok{1}\NormalTok{],}
\NormalTok{                  [width, height, }\DecValTok{1}\NormalTok{]])}
\NormalTok{    C\_new }\OperatorTok{=}\NormalTok{ np.array([(np.dot(i, M.T) }\OperatorTok{/}\NormalTok{ np.dot(i, M.T)[}\DecValTok{2}\NormalTok{])[:}\DecValTok{2}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ C])}

\NormalTok{    C\_new[:, }\DecValTok{0}\NormalTok{] }\OperatorTok{{-}=} \BuiltInTok{min}\NormalTok{(C\_new[:, }\DecValTok{0}\NormalTok{])}
\NormalTok{    C\_new[:, }\DecValTok{1}\NormalTok{] }\OperatorTok{{-}=} \BuiltInTok{min}\NormalTok{(C\_new[:, }\DecValTok{1}\NormalTok{])}
    
    \CommentTok{\# d√©finir une nouvelle matrice de transformation bas√©e sur les coins de l\textquotesingle{}image}
    \CommentTok{\# sinon, une partie des images ne sera pas enregistr√©e}
\NormalTok{    M\_new }\OperatorTok{=}\NormalTok{ cv2.getPerspectiveTransform(np.float32(C[:,:}\DecValTok{2}\NormalTok{]), np.float32(C\_new))}

    \ControlFlowTok{return}\NormalTok{ M\_new, C\_new, df\_to}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#d√©terminer les param√®tres d\textquotesingle{}orthorectification}
\NormalTok{M, C, \_\_ }\OperatorTok{=}\NormalTok{ orthorect\_param(corr\_img, df\_from, df\_to, PPM}\OperatorTok{=}\DecValTok{100}\NormalTok{)}

\CommentTok{\# d√©finir la taille de l\textquotesingle{}image orthorectifi√©e}
\NormalTok{cols }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(np.ceil(}\BuiltInTok{max}\NormalTok{(C[:, }\DecValTok{0}\NormalTok{])))}
\NormalTok{rows }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(np.ceil(}\BuiltInTok{max}\NormalTok{(C[:, }\DecValTok{1}\NormalTok{])))}


\CommentTok{\# orthorectifier l\textquotesingle{}image}

\NormalTok{fig }\OperatorTok{=}\NormalTok{ plt.figure(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{7}\NormalTok{,}\DecValTok{4}\NormalTok{))}
\NormalTok{plt.subplots\_adjust(left}\OperatorTok{=}\DecValTok{0}\NormalTok{, bottom}\OperatorTok{=}\DecValTok{0}\NormalTok{, right}\OperatorTok{=}\DecValTok{1}\NormalTok{, top}\OperatorTok{=}\DecValTok{1}\NormalTok{, wspace}\OperatorTok{=}\FloatTok{0.1}\NormalTok{, hspace}\OperatorTok{=}\DecValTok{0}\NormalTok{)}

\NormalTok{plt.subplot(}\DecValTok{111}\NormalTok{)}
\NormalTok{ortho\_img }\OperatorTok{=}\NormalTok{ cv2.warpPerspective(img, M, (cols, rows))}
\NormalTok{plt.imshow(ortho\_img[:,:,::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\NormalTok{plt.axis(}\StringTok{\textquotesingle{}off\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (-0.5, 2085.5, 1516.5, -0.5)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
\includegraphics[width=1\linewidth,]{PROJET_LSPIV_files/figure-latex/unnamed-chunk-12-1} \caption{L'orthorectification}\label{fig:unnamed-chunk-12}
\end{figure}

\hypertarget{la-mise-en-niveau-de-gris-et-la-correction-du-gamma-et-du-contraste.}{%
\subsection*{La mise en niveau de gris et la correction du gamma et du contraste.}\label{la-mise-en-niveau-de-gris-et-la-correction-du-gamma-et-du-contraste.}}
\addcontentsline{toc}{subsection}{La mise en niveau de gris et la correction du gamma et du contraste.}

La derni√®re √©tape de la pr√©paration de l'image est la conversion du
imagerie √† une √©chelle de gris et pour appliquer une correction de contraste et gamma.
Une mise √† l'√©chelle des gris est n√©cessaire pour pouvoir appliquer la validation de similarit√© entre
images vid√©o s√©quentielles. La correction de contraste et gamma est appliqu√©e √†
am√©liorer la visibilit√© des semences. Les corrections de contraste et gamma sont
appliqu√© √† l'aide des formules suivantes:

\begin{equation}
O_{constract} = \alpha \cdot I + \beta
\label{eq:constract}
\end{equation}

\begin{equation}
O_{gamma} = \left(\frac{I}{255}\right)^\frac{1}{\gamma} \cdot 255
\label{eq:gamma}
\end{equation}

D'o√π \(\alpha\) et \(\beta\) d√©finit la correction du contrasteÕæ \(\gamma\) est la correction de gammaÕæ \(O_n\) sont les imageries corrig√©sÕæ et \(I\) est l'imagerie d'origine.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gamma}\OperatorTok{=}\FloatTok{0.4}

\CommentTok{\# transformer l\textquotesingle{}image en niveaux de gris}
\NormalTok{Grey\_img }\OperatorTok{=}\NormalTok{ cv2.cvtColor(ortho\_img, cv2.COLOR\_BGR2GRAY)}

\CommentTok{\# appliquer la correction gamma}
\NormalTok{invGamma }\OperatorTok{=} \FloatTok{1.}\OperatorTok{/}\NormalTok{gamma}
\NormalTok{table }\OperatorTok{=}\NormalTok{ (np.array([((i }\OperatorTok{/} \FloatTok{255.0}\NormalTok{) }\OperatorTok{**}\NormalTok{ invGamma) }\OperatorTok{*} \DecValTok{255} 
            \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{256}\NormalTok{)]).astype(}\StringTok{\textquotesingle{}uint8\textquotesingle{}}\NormalTok{))}
    
\NormalTok{Gamma\_img }\OperatorTok{=}\NormalTok{ cv2.LUT(Grey\_img, table)}


\NormalTok{fig }\OperatorTok{=}\NormalTok{ plt.figure(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{14}\NormalTok{,}\DecValTok{4}\NormalTok{))}
\NormalTok{plt.subplots\_adjust(left}\OperatorTok{=}\DecValTok{0}\NormalTok{, bottom}\OperatorTok{=}\DecValTok{0}\NormalTok{, right}\OperatorTok{=}\DecValTok{1}\NormalTok{, top}\OperatorTok{=}\DecValTok{1}\NormalTok{, wspace}\OperatorTok{=}\FloatTok{0.1}\NormalTok{, hspace}\OperatorTok{=}\DecValTok{0}\NormalTok{)}

\NormalTok{plt.subplot(}\DecValTok{121}\NormalTok{)}
\NormalTok{plt.imshow(Grey\_img,cmap}\OperatorTok{=}\StringTok{"gray"}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}GRAY SCALE\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.axis(}\StringTok{\textquotesingle{}off\textquotesingle{}}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (-0.5, 2085.5, 1516.5, -0.5)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.subplot(}\DecValTok{122}\NormalTok{)}
\NormalTok{plt.imshow(Gamma\_img, }\StringTok{\textquotesingle{}gray\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}GAMMA\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.axis(}\StringTok{\textquotesingle{}off\textquotesingle{}}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (-0.5, 2085.5, 1516.5, -0.5)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
\includegraphics[width=1\linewidth,]{PROJET_LSPIV_files/figure-latex/unnamed-chunk-13-1} \caption{L'orthorectification}\label{fig:unnamed-chunk-13}
\end{figure}

\hypertarget{pour-tous-les-images}{%
\subsection*{Pour tous les images}\label{pour-tous-les-images}}
\addcontentsline{toc}{subsection}{Pour tous les images}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# compteur √† utiliser comme nom pour les images individuelles}
\NormalTok{n }\OperatorTok{=} \DecValTok{0}
\NormalTok{gamma}\OperatorTok{=}\FloatTok{0.4}

\CommentTok{\# importer une vid√©o et lire chaque image individuelle (cadre)}
\NormalTok{cap }\OperatorTok{=}\NormalTok{ cv2.VideoCapture(dir\_video)}
\ControlFlowTok{while}\NormalTok{ cap.isOpened():}
\NormalTok{    ret, img }\OperatorTok{=}\NormalTok{ cap.read()}
    \ControlFlowTok{if}\NormalTok{ ret:}

        \CommentTok{\# appliquer la correction de la distorsion de l\textquotesingle{}objectif}
\NormalTok{        img\_dist }\OperatorTok{=}\NormalTok{ lens\_corr(img, k1}\OperatorTok{={-}}\FloatTok{10.0e{-}6}\NormalTok{, c}\OperatorTok{=}\DecValTok{2}\NormalTok{, f}\OperatorTok{=}\FloatTok{8.0}\NormalTok{)}

        \CommentTok{\# appliquer une orthorectification}
\NormalTok{        img\_orth }\OperatorTok{=}\NormalTok{ cv2.warpPerspective(img\_dist, M, (cols, rows))}

        \CommentTok{\# appliquer une √©chelle de gris, une correction du contraste et du gamma}
\NormalTok{        img\_grey }\OperatorTok{=}\NormalTok{ cv2.cvtColor(img\_orth, cv2.COLOR\_BGR2GRAY)}
\NormalTok{        Gamma\_img }\OperatorTok{=}\NormalTok{ cv2.LUT(img\_grey, table)}

        \CommentTok{\# rogner l\textquotesingle{}image √† une taille plus raisonnable en excluant les limites ext√©rieures}
        \CommentTok{\# l\textquotesingle{}image pourrait √™tre recadr√©e dans l\textquotesingle{}√©tendue de la zone d\textquotesingle{}int√©r√™t}
\NormalTok{        img\_out }\OperatorTok{=}\NormalTok{ Gamma\_img[}\BuiltInTok{max}\NormalTok{(}\DecValTok{0}\NormalTok{, rows}\OperatorTok{{-}}\DecValTok{1000}\NormalTok{):, :}\BuiltInTok{min}\NormalTok{(}\DecValTok{2000}\NormalTok{, cols)]}

        \CommentTok{\# enregistrez l\textquotesingle{}image avec le nom \textquotesingle{}n\textquotesingle{}}
\NormalTok{        framename }\OperatorTok{=}\NormalTok{ os.path.join(dir\_saves,}
                                 \StringTok{\textquotesingle{}frame\_\textquotesingle{}}\OperatorTok{+}\BuiltInTok{str}\NormalTok{(}\BuiltInTok{format}\NormalTok{(n).zfill(}\DecValTok{6}\NormalTok{))}\OperatorTok{+}\StringTok{\textquotesingle{}.jpg\textquotesingle{}}\NormalTok{)}
\NormalTok{        cv2.imwrite(framename, img\_out)}
\NormalTok{        n }\OperatorTok{+=} \DecValTok{1}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{break}
\NormalTok{cap.release()}
\end{Highlighting}
\end{Shaded}

\hypertarget{piv}{%
\section*{le traitement PIV}\label{piv}}
\addcontentsline{toc}{section}{le traitement PIV}

La figure \ref{fig:fpivprocessing} montre les √©tapes du traitement PIV. Pour deux s√©quentiels cadres, les images sont divis√©es en cellules de grille. En d√©terminant validation de similarit√© - par exemple, une corr√©lation crois√©e ou une rapport signal / bruit \citetext{\citealp[ ]{ran_application_2016}; \citealp{osorio-cano_method_2013}} - entre les deux cadres de la zone de recherche, les d√©placements peuvent √™tre d√©termin√©. Ces d√©placements sont ensuite convertis en vitesse d'√©coulement vecteurs.

Apr√®s avoir appliqu√© ce processus sur \(ùëÅ\) images, un total de \(ùëÅ‚àí 1\) cartes de vitesse sont cr√©√©es. Pour chaque carte de vitesse, les r√©sultats peuvent √™tre encore am√©lior√©s en appliquant un filtrage suppl√©mentaire bas√© sur la valeur de similarit√© dans chaque fen√™tre d'interrogation unique, et en rempla√ßant ces valeurs filtr√©es par interpolation les cellules de la grille environnantes connues. Ces post-traitements les √©tapes d√©pendent du logiciel utilis√© ou des r√©sultats requis.



\begin{figure}[H]
\includegraphics[width=1\linewidth,]{images/pivprocessing} \caption{Vue sch√©matique de la m√©thode LSPIV o√π une fen√™tre d'interrogation est d√©termin√©e (la grille est dessin√©e plus grande dan g√©n√©ralement appliqu√©) dans la premi√®re image et les graines pr√©sentes sont compar√©es √† une zone de recherche dans l'image s√©quentielle 2 √† d√©terminer leurs d√©placements. En multipliant le d√©placement par la p√©riode de temps de trame, la vitesse est d√©termin√©e. Lorsque vous appliquez ceci sur toute l'image, une carte de vitesse d'√©coulement de surface peut √™tre cr√©√©e pour chaque image individuelle.}\label{fig:fpivprocessing}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ os}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{from}\NormalTok{ tqdm }\ImportTok{import}\NormalTok{ tqdm}
\ImportTok{from}\NormalTok{ openpiv }\ImportTok{import}\NormalTok{ tools,pyprocess,validation, filters,scaling}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ PIV(}
\NormalTok{    frame\_0,}
\NormalTok{    frame\_1,}
\NormalTok{    winsize,}
\NormalTok{    searchsize,}
\NormalTok{    overlap,}
\NormalTok{    frame\_rate,}
\NormalTok{    scaling\_factor,}
\NormalTok{    threshold}\OperatorTok{=}\FloatTok{1.3}\NormalTok{,}
\NormalTok{    output}\OperatorTok{=}\StringTok{\textquotesingle{}fil\textquotesingle{}}\NormalTok{ ):}

    \CommentTok{\# d√©terminer le pas de temps entre les deux images s√©quentielles (1 / fps)}
\NormalTok{    dt }\OperatorTok{=} \FloatTok{1.}\OperatorTok{/}\NormalTok{frame\_rate}

    \CommentTok{\# estimation des d√©placements de graines dans les directions x et y}
    \CommentTok{\# et le rapport signal / bruit correspondant}
\NormalTok{    u, v, sig2noise }\OperatorTok{=}\NormalTok{ pyprocess.extended\_search\_area\_piv(}
\NormalTok{                        frame\_a }\OperatorTok{=}\NormalTok{ frame\_0,}
\NormalTok{                        frame\_b }\OperatorTok{=}\NormalTok{ frame\_1,}
\NormalTok{                        window\_size }\OperatorTok{=}\NormalTok{ winsize,}
\NormalTok{                        overlap }\OperatorTok{=}\NormalTok{ overlap,}
\NormalTok{                        dt}\OperatorTok{=}\NormalTok{dt,}
\NormalTok{                        search\_area\_size }\OperatorTok{=}\NormalTok{ searchsize,      }
\NormalTok{                        sig2noise\_method }\OperatorTok{=} \StringTok{\textquotesingle{}peak2peak\textquotesingle{}}\NormalTok{)}

    \CommentTok{\# coordonn√©es xy du centre de chaque cellule de la grille}
\NormalTok{    x, y }\OperatorTok{=}\NormalTok{ pyprocess.get\_coordinates(image\_size}\OperatorTok{=}\NormalTok{frame\_0.shape,}
\NormalTok{                                     search\_area\_size}\OperatorTok{=}\NormalTok{winsize,}
\NormalTok{                                     overlap}\OperatorTok{=}\NormalTok{overlap)}

    \CommentTok{\# si la sortie est \textquotesingle{}fill\textquotesingle{} ou \textquotesingle{}int\textquotesingle{}:}
    \CommentTok{\# filtrer les cellules de la grille avec un faible rapport signal / bruit}
    \ControlFlowTok{if}\NormalTok{ output }\OperatorTok{==} \StringTok{\textquotesingle{}fil\textquotesingle{}} \KeywordTok{or}\NormalTok{  output }\OperatorTok{==} \StringTok{\textquotesingle{}int\textquotesingle{}}\NormalTok{:}
\NormalTok{        u, v, mask }\OperatorTok{=}\NormalTok{ validation.sig2noise\_val(u,}
\NormalTok{                                              v,}
\NormalTok{                                              sig2noise,}
\NormalTok{                                              threshold}\OperatorTok{=}\NormalTok{threshold)}

    \CommentTok{\# si la sortie est \textquotesingle{}int\textquotesingle{}}
    \CommentTok{\# remplir les valeurs manquantes par interpolation}
    \ControlFlowTok{if}\NormalTok{ output }\OperatorTok{==} \StringTok{\textquotesingle{}int\textquotesingle{}}\NormalTok{:}
\NormalTok{        u, v }\OperatorTok{=}\NormalTok{ filters.replace\_outliers(u,}
\NormalTok{                                        v,}
\NormalTok{                                        method}\OperatorTok{=}\StringTok{\textquotesingle{}localmean\textquotesingle{}}\NormalTok{,}
\NormalTok{                                        max\_iter}\OperatorTok{=}\DecValTok{50}\NormalTok{,}
\NormalTok{                                        kernel\_size}\OperatorTok{=}\DecValTok{3}\NormalTok{)}

    \CommentTok{\# mettre √† l\textquotesingle{}√©chelle les r√©sultats en fonction des pixels par m√®tre}
\NormalTok{    x, y, u, v }\OperatorTok{=}\NormalTok{ scaling.uniform(x,}
\NormalTok{                                 y,}
\NormalTok{                                 u,}
\NormalTok{                                 v,}
\NormalTok{                                 scaling\_factor}\OperatorTok{=}\NormalTok{scaling\_factor)}

    \ControlFlowTok{return}\NormalTok{ x, y, u, v, sig2noise}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dir\_frames }\OperatorTok{=} \StringTok{\textquotesingle{}Python/frames\textquotesingle{}}
\NormalTok{dir\_saves }\OperatorTok{=} \StringTok{\textquotesingle{}Python/files\textquotesingle{}}

\ControlFlowTok{if} \KeywordTok{not}\NormalTok{ os.path.exists(dir\_saves):}
\NormalTok{    os.mkdir(dir\_saves)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{winsize }\OperatorTok{=}  \DecValTok{60}            \CommentTok{\# pixels, taille de la fen√™tre d\textquotesingle{}interrogation dans l\textquotesingle{}image A}
\NormalTok{searchsize }\OperatorTok{=}\NormalTok{ winsize     }\CommentTok{\# pixels, recherche dans l\textquotesingle{}image B}
\NormalTok{overlap }\OperatorTok{=}  \DecValTok{30}            \CommentTok{\# pixels, chevauchement de 50\%}
\NormalTok{frame\_rate }\OperatorTok{=} \DecValTok{25}          \CommentTok{\# vid√©o √† fr√©quence d\textquotesingle{}images}
\NormalTok{scaling\_factor }\OperatorTok{=} \DecValTok{100}     \CommentTok{\# pixels par m√®tre (PPM)}
\NormalTok{threshold }\OperatorTok{=} \FloatTok{1.3}          \CommentTok{\# rapport signal / bruit auquel les r√©sultats sont filtr√©s}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# importer les noms et le nombre de cadres}
\NormalTok{frames }\OperatorTok{=}\NormalTok{ os.listdir(dir\_frames)}
\NormalTok{N }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(frames)}\OperatorTok{{-}}\DecValTok{1}

\ControlFlowTok{for}\NormalTok{ n }\KeywordTok{in}\NormalTok{ tqdm(}\BuiltInTok{range}\NormalTok{(N)):}
    \CommentTok{\# d√©finir les deux trames s√©quentielles utilis√©es pour estimer le champ de vitesse}
\NormalTok{    frame\_0 }\OperatorTok{=}\NormalTok{ tools.imread(os.path.join(dir\_frames,}\BuiltInTok{str}\NormalTok{(frames[n])))}
\NormalTok{    frame\_1 }\OperatorTok{=}\NormalTok{ tools.imread(os.path.join(dir\_frames,}\BuiltInTok{str}\NormalTok{(frames[n}\OperatorTok{+}\DecValTok{1}\NormalTok{])))}

    \CommentTok{\# Traitement PIV}
\NormalTok{    x, y, u, v, sig2noise }\OperatorTok{=}\NormalTok{ PIV(frame\_0, frame\_1, winsize, searchsize,}
\NormalTok{                                overlap, frame\_rate, scaling\_factor,}
\NormalTok{                                threshold, output}\OperatorTok{=}\StringTok{\textquotesingle{}fil\textquotesingle{}}\NormalTok{)}

    \CommentTok{\# enregistrer les r√©sultats dans un fichier texte}
\NormalTok{    tools.save(x,}
\NormalTok{               y,}
\NormalTok{               u,}
\NormalTok{               v,}
\NormalTok{               sig2noise,}
\NormalTok{               os.path.join(dir\_saves, }\BuiltInTok{str}\NormalTok{(}\BuiltInTok{format}\NormalTok{(n).zfill(}\DecValTok{6}\NormalTok{))}\OperatorTok{+}\StringTok{\textquotesingle{}.txt\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{ad}{%
\section*{l'analyse des donn√©e}\label{ad}}
\addcontentsline{toc}{section}{l'analyse des donn√©e}

Ce fichier traite deux √©tapes de post-traitement pour acqu√©rir des vitesses d'√©coulement de surface √† une section transversale sp√©cifique. Les √©tapes de post-traitement sont nomm√©es filtrage et substitution . Les deux processus sont expliqu√©s dans les sections suivantes. Pour ces √©tapes, plusieurs informations suppl√©mentaires sont n√©cessaires √† savoir:

\begin{itemize}
\item
  bathym√©trie locale,
\item
  niveau d'eau,
\item
  param√®tres de progression verticale des vitesses d'√©coulement de surface.
\end{itemize}

Dans les sections √† venir, traiter les sujets suivants: (1) les r√©sultats non trait√©s, (2) le filtrage des vitesses d'√©coulement inf√©rieures, et (3) la substitution des vitesses d'√©coulement en cas de manque de graines.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ os}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{from}\NormalTok{ scipy }\ImportTok{import}\NormalTok{ interpolate}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dir\_files }\OperatorTok{=} \StringTok{\textquotesingle{}Python/files\textquotesingle{}}
\NormalTok{bat }\OperatorTok{=} \VerbatimStringTok{r\textquotesingle{}Python/bathymetry.csv\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\hypertarget{ruxe9sultats-non-traituxe9s}{%
\subsection*{R√©sultats non trait√©s}\label{ruxe9sultats-non-traituxe9s}}
\addcontentsline{toc}{subsection}{R√©sultats non trait√©s}

la zone d'int√©r√™t se situe √† 1 m√®tre √† gauche et √† trois m√®tres √† droite du point central de la bathym√©trie (fournie dans le fichier bathymetry.csv). Comme l'√©coulement va de gauche √† droite, seules les composantes x des vitesses d'√©coulement sont utilis√©es pour estimer les vitesses d'√©coulement moyennes.

La largeur du ruisseau est divis√©e en diff√©rentes sections transversales. Pour chaque section, les vitesses d'√©coulement sont rassembl√©es et une valeur moyenne est d√©termin√©e.

Tout d'abord, certaines caract√©ristiques de base sont prouv√©es. L'emplacement du centre de la bathym√©trie dans l'imagerie (\(centre_x\) et \(centre_y\)), les emplacements des berges du cours d'eau √† la bathym√©trie (\(y_0\) et \(y_1\)), et le niveau d'eau (\(w_l\)) pendant la vid√©o.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# localisation de la bathym√©trie du centre dans l\textquotesingle{}imagerie (m√®tres).}
\CommentTok{\# Utilis√© pour aligner les vitesses d\textquotesingle{}√©coulement avec la bathym√©trie}
\NormalTok{centre\_x, centre\_y }\OperatorTok{=}\NormalTok{ [}\FloatTok{8.3471579}\NormalTok{ , }\FloatTok{2.01868403}\NormalTok{]}

\CommentTok{\# emplacements banques de flux}
\NormalTok{y0, y1 }\OperatorTok{=}\NormalTok{ [}\OperatorTok{{-}}\FloatTok{1.397}\NormalTok{, }\FloatTok{3.785}\NormalTok{]}

\CommentTok{\# niveau d\textquotesingle{}eau (par rapport au point bathym√©trique le plus bas)}
\NormalTok{wl }\OperatorTok{=} \FloatTok{0.9}
\end{Highlighting}
\end{Shaded}

La bathym√©trie se trouve dans le fichier \textbf{bathymetry.csv}. Pour utiliser cette bathym√©trie, les points sont interpol√©s √† l'aide de la fonction scipy.interpolate.interpolate.

\begin{Shaded}
\begin{Highlighting}[]

\CommentTok{\# importer la bathym√©trie locale}
\NormalTok{df\_bat }\OperatorTok{=}\NormalTok{ pd.read\_table(bat, sep}\OperatorTok{=}\StringTok{\textquotesingle{};\textquotesingle{}}\NormalTok{, usecols}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Y\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}H\textquotesingle{}}\NormalTok{])}
\CommentTok{\# fonction interpol√©e de la bathym√©trie}
\NormalTok{func\_bat }\OperatorTok{=}\NormalTok{ interpolate.interp1d(df\_bat[}\StringTok{\textquotesingle{}Y\textquotesingle{}}\NormalTok{], df\_bat[}\StringTok{\textquotesingle{}H\textquotesingle{}}\NormalTok{], kind}\OperatorTok{=}\StringTok{\textquotesingle{}quadratic\textquotesingle{}}\NormalTok{)}


\NormalTok{plt.figure(figsize}\OperatorTok{=}\NormalTok{ (}\DecValTok{12}\NormalTok{,}\DecValTok{4}\NormalTok{))}
\NormalTok{plt.scatter(df\_bat.Y,df\_bat.H,alpha}\OperatorTok{=}\FloatTok{0.5}\NormalTok{,label }\OperatorTok{=}\StringTok{"Mesures individuelles"}\NormalTok{)}
\NormalTok{plt.plot(df\_bat.Y,func\_bat(df\_bat.Y),color }\OperatorTok{=}\StringTok{"black"}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.3}\NormalTok{,label}\OperatorTok{=} \StringTok{"Bathym√©trie interpol√©e"}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Y [m]\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Z [m]\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.legend(loc }\OperatorTok{=} \StringTok{\textquotesingle{}lower right\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
\includegraphics[width=1\linewidth,]{PROJET_LSPIV_files/figure-latex/unnamed-chunk-17-1} \caption{la bathym√©trie locale}\label{fig:unnamed-chunk-17}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# extraire les noms des fichiers texte}
\NormalTok{files }\OperatorTok{=}\NormalTok{ os.listdir(dir\_files)}

\CommentTok{\# cr√©er un dataframe dans lequel toutes les vitesses de la zone d\textquotesingle{}int√©r√™t sont stock√©es}
\NormalTok{vx\_all }\OperatorTok{=}\NormalTok{ pd.DataFrame()}

\CommentTok{\# cr√©er un tableau pour enregistrer les vitesses moyennes}
\NormalTok{vx\_mean\_raw }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for} \BuiltInTok{file} \KeywordTok{in}\NormalTok{ files:}
    \CommentTok{\# importer un fichier unique et ajouter des vitesses dans la zone d\textquotesingle{}int√©r√™t}
    \CommentTok{\# √† la trame de donn√©es}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ pd.read\_table(os.path.join(dir\_files, }\BuiltInTok{file}\NormalTok{),}
\NormalTok{                       sep}\OperatorTok{=}\StringTok{\textquotesingle{}\textbackslash{}s+\textquotesingle{}}\NormalTok{,}
\NormalTok{                       names}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}X\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Y\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Vx\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Vy\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}s2n\textquotesingle{}}\NormalTok{),}
\NormalTok{                       header}\OperatorTok{=}\DecValTok{0}\NormalTok{,}
\NormalTok{                       index\_col}\OperatorTok{=} \VariableTok{False}\NormalTok{)  }
\NormalTok{    df[}\StringTok{\textquotesingle{}X\textquotesingle{}}\NormalTok{]}\OperatorTok{=}\NormalTok{df[}\StringTok{\textquotesingle{}X\textquotesingle{}}\NormalTok{].astype(}\StringTok{\textquotesingle{}float\textquotesingle{}}\NormalTok{)}
\NormalTok{    df[}\StringTok{\textquotesingle{}Y\textquotesingle{}}\NormalTok{]}\OperatorTok{=}\NormalTok{df[}\StringTok{\textquotesingle{}Y\textquotesingle{}}\NormalTok{].astype(}\StringTok{\textquotesingle{}float\textquotesingle{}}\NormalTok{)}
\NormalTok{    df[}\StringTok{\textquotesingle{}Vx\textquotesingle{}}\NormalTok{]}\OperatorTok{=}\NormalTok{df[}\StringTok{\textquotesingle{}Vx\textquotesingle{}}\NormalTok{].astype(}\StringTok{\textquotesingle{}float\textquotesingle{}}\NormalTok{)}
\NormalTok{    df[}\StringTok{\textquotesingle{}Vy\textquotesingle{}}\NormalTok{]}\OperatorTok{=}\NormalTok{df[}\StringTok{\textquotesingle{}Vy\textquotesingle{}}\NormalTok{].astype(}\StringTok{\textquotesingle{}float\textquotesingle{}}\NormalTok{)}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df[df[}\StringTok{\textquotesingle{}X\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}}\NormalTok{ (centre\_x }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)]}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df[df[}\StringTok{\textquotesingle{}X\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}}\NormalTok{ (centre\_x }\OperatorTok{+} \DecValTok{3}\NormalTok{)]}
\NormalTok{    vx\_all }\OperatorTok{=}\NormalTok{ vx\_all.append(df)}

\CommentTok{\# d√©finir les diff√©rentes coordonn√©es y (sections de largeur de flux)}
\NormalTok{y\_unique }\OperatorTok{=}\NormalTok{ np.sort(df.Y.unique())}
    
\CommentTok{\# corriger les coordonn√©es y par rapport au \textquotesingle{}centre\textquotesingle{} bathym√©trique}
\NormalTok{y\_corrected }\OperatorTok{=}\NormalTok{ y\_unique }\OperatorTok{{-}}\NormalTok{ centre\_y}
\end{Highlighting}
\end{Shaded}

\hypertarget{filtrage}{%
\subsection*{Filtrage}\label{filtrage}}
\addcontentsline{toc}{subsection}{Filtrage}

Comme la densit√© d'ensemencement n'est pas assez dense pour avoir des graines √† chaque cellule de la grille, il y a des moments o√π aucune vitesse d'√©coulement de surface n'est estim√©e, ce qui entra√Æne une large gamme de vitesses d'√©coulement. Par cons√©quent, un filtrage suppl√©mentaire est appliqu√© pour supprimer les estimations de vitesse d'√©coulement inf√©rieure.

Ce filtrage est bas√© sur la distance d'une mesure par rapport √† la vitesse d'√©coulement du 95e percentile dans cette section transversale. Si une valeur est plus √©loign√©e que deux fois l'√©cart type du 95er centile, cette valeur est filtr√©e. Ou en bref, le filtrage est appliqu√© lorsque l'instruction suivante est remplie:

\begin{equation}
V_{X} < V_{q95} - 2 \cdot \sigma_{V_{X}}
\end{equation}

Comme cette d√©claration peut entra√Æner un filtrage excessif, une autre instruction (ou seuil) doit √™tre satisfaite avant que le filtrage ne soit appliqu√© √† une section transversale. Le 95e centile doit √™tre sup√©rieur √† 2,5 fois l'√©cart type:

\begin{equation}
V_{q95} > 2.5 \cdot \sigma_{V_{X}}
\end{equation}

Les nouvelles estimations des vitesses d'√©coulement moyennes peuvent √™tre faites.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# tableau pour stocker les vitesses d\textquotesingle{}√©coulement moyennes}
\NormalTok{vx\_mean\_fil }\OperatorTok{=}\NormalTok{ []}

\CommentTok{\# pour chaque section transversale}
\CommentTok{\# trouver les vitesses d\textquotesingle{}√©coulement correspondantes et supprimer les valeurs NaN}
\ControlFlowTok{for}\NormalTok{ yy }\KeywordTok{in}\NormalTok{ y\_unique:}
\NormalTok{    vxi }\OperatorTok{=}\NormalTok{ vx\_all.Vx[vx\_all.Y }\OperatorTok{==}\NormalTok{ yy]}
\NormalTok{    vxi }\OperatorTok{=}\NormalTok{ vxi[np.isfinite(vxi)]}

    \CommentTok{\# si toutes les valeurs sont NaN, cr√©ez un tableau de longueur 1}
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(vxi) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
\NormalTok{        vxi }\OperatorTok{=}\NormalTok{ [}\DecValTok{0}\NormalTok{]}
    
    \CommentTok{\# d√©terminer le 95e quantile et l\textquotesingle{}√©cart type}
\NormalTok{    v\_filter }\OperatorTok{=}\NormalTok{ np.quantile(vxi, }\FloatTok{0.95}\NormalTok{)}
\NormalTok{    std }\OperatorTok{=}\NormalTok{ np.std(vxi)}

    \CommentTok{\# le filtrage est appliqu√© si le 95e centile\textgreater{} 2,5 * std}
    \ControlFlowTok{if} \FloatTok{2.5}\OperatorTok{*}\NormalTok{std}\OperatorTok{/}\NormalTok{v\_filter }\OperatorTok{\textless{}} \DecValTok{1}\NormalTok{:}
        \CommentTok{\# le filtrage est appliqu√© sur les valeurs plus √©loign√©es que 2 * std du 95e centile}
\NormalTok{        vxi\_in }\OperatorTok{=}\NormalTok{ vxi[vxi }\OperatorTok{\textgreater{}}\NormalTok{ v\_filter }\OperatorTok{{-}} \DecValTok{2}\OperatorTok{*}\NormalTok{std]}
\NormalTok{        vxi\_out }\OperatorTok{=}\NormalTok{ vxi[vxi }\OperatorTok{\textless{}}\NormalTok{ v\_filter }\OperatorTok{{-}} \DecValTok{2}\OperatorTok{*}\NormalTok{std]}
        \CommentTok{\# ajouter une valeur moyenne en fonction des r√©sultats filtr√©s}
\NormalTok{        vx\_mean\_fil.append(np.mean(vxi\_in))}

    \CommentTok{\# si le filtrage n\textquotesingle{}est pas appliqu√©: d√©terminer la moyenne sur toutes les valeurs}
    \ControlFlowTok{else}\NormalTok{:}
\NormalTok{      vx\_mean\_fil.append(np.mean(vxi))}
\end{Highlighting}
\end{Shaded}

\hypertarget{substitution}{%
\subsection*{Substitution}\label{substitution}}
\addcontentsline{toc}{subsection}{Substitution}

Comme dans certaines sections transversales aucune graine n'est pr√©sente, les vitesses d'√©coulement sont √† coup s√ªr sous-estim√©es √† ces endroits. Pour encore faire une estimation √©clair√©e des vitesses d'√©coulement √† ces endroits, les vitesses d'√©coulement √† diff√©rents stades de l'onde de crue sont estim√©es et utilis√©es pour √©tablir une relation entre les vitesses d'√©coulement de surface et la profondeur de l'eau. Cette relation est approch√©e en utilisant la loi logarithmique de Prandtl-von K√°rm√°n:

\begin{equation}
V_{x_sub}(h) = \frac{u_{\star}}{\kappa} \ln\left[\frac{h - d}{h_0}\right]
\end{equation}

Dans cette formule \(V_{x_sub}(h)\) est la vitesse d'√©coulement √† la profondeur de l'eau \(h\); \(u_{\star}\) est la vitesse de cisaillement;\(\kappa\) est la constante de von K√°rm√°n (\(\approx 0.41\)); \(h_0\) est la profondeur de rugosit√©; \(d\) est le d√©placement dans le plan z√©ro. Pour l'exemple de vid√©o, \(u_{\star}\) , \(h_0\) et \(d\) sont estim√©s √† \(0.235\) , \(0.054\) et \(0.15\).

Les vitesses d'√©coulement de surface sont remplac√©es si la vitesse d'√©coulement de surface est la moiti√© de la valeur de substitution et lorsque la section se trouve dans les berges du cours d'eau.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ vertical\_flow(loc\_wd, p, d}\OperatorTok{=}\FloatTok{0.15}\NormalTok{):}
\NormalTok{    us }\OperatorTok{=}\NormalTok{ p[}\DecValTok{0}\NormalTok{]}
\NormalTok{    h0 }\OperatorTok{=}\NormalTok{ p[}\DecValTok{1}\NormalTok{]}
    \ControlFlowTok{return}\NormalTok{ us}\OperatorTok{/}\FloatTok{0.41} \OperatorTok{*}\NormalTok{ np.log((loc\_wd }\OperatorTok{{-}}\NormalTok{ d) }\OperatorTok{/}\NormalTok{ h0)}

\CommentTok{\# param√®tres de vitesse d\textquotesingle{}√©coulement de surface de progression verticale}
\NormalTok{param }\OperatorTok{=}\NormalTok{ [}\FloatTok{0.235}\NormalTok{, }\FloatTok{0.054}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# cr√©er une copie des vitesses d\textquotesingle{}√©coulement moyennes filtr√©es}
\NormalTok{vx\_mean\_rep }\OperatorTok{=}\NormalTok{ vx\_mean\_fil.copy()}

\CommentTok{\# d√©terminer les profondeurs d\textquotesingle{}eau √† diff√©rentes coordonn√©es y corrig√©es}
\CommentTok{\# s\textquotesingle{}il y a de l\textquotesingle{}eau (wd\textgreater{} 0) et si y est compris entre {-}3 et 3 (pas de buissons)}
\CommentTok{\# si moyenne * 2 \textless{}valeur trouv√©e en utilisant le profil vertical}
\NormalTok{wd }\OperatorTok{=}\NormalTok{ wl }\OperatorTok{{-}}\NormalTok{ func\_bat(y\_corrected)}
\ControlFlowTok{for}\NormalTok{ nn, loc\_wd }\KeywordTok{in} \BuiltInTok{enumerate}\NormalTok{(wd):}
    \ControlFlowTok{if}\NormalTok{ loc\_wd }\OperatorTok{\textgreater{}} \FloatTok{0.15}\NormalTok{:}
        \ControlFlowTok{if}\NormalTok{ (y\_corrected[nn] }\OperatorTok{\textgreater{}} \OperatorTok{{-}}\FloatTok{3.5}\NormalTok{) }\KeywordTok{and}\NormalTok{ y\_corrected[nn] }\OperatorTok{\textless{}} \FloatTok{3.5}\NormalTok{:}
            \CommentTok{\# si 2 * la valeur m√©diane est inf√©rieure √† la valeur corrig√©e: valeur correcte}
            \CommentTok{\# tous les centiles}
            \ControlFlowTok{if}\NormalTok{ vx\_mean\_rep[nn] }\OperatorTok{\textless{}} \FloatTok{0.5}\OperatorTok{*}\NormalTok{vertical\_flow(loc\_wd, param):}
\NormalTok{                    vx\_mean\_rep[nn] }\OperatorTok{=}\NormalTok{ vertical\_flow(loc\_wd, param)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# afficher les vitesses individuelles et les vitesses moyennes des diff√©rentes √©tapes }
\CommentTok{\# de post{-}traitement}
\NormalTok{fig }\OperatorTok{=}\NormalTok{ plt.figure(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{6}\NormalTok{,}\DecValTok{9}\NormalTok{))}
\NormalTok{plt.plot(vx\_mean\_rep, y\_corrected,}
\NormalTok{         color}\OperatorTok{=}\StringTok{\textquotesingle{}darkred\textquotesingle{}}\NormalTok{, marker}\OperatorTok{=}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{, zorder}\OperatorTok{=}\DecValTok{2}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.75}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Substitu√©\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.hlines([y0, y1], xmin}\OperatorTok{={-}}\FloatTok{0.35}\NormalTok{, xmax}\OperatorTok{=}\DecValTok{1}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}k\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.3}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Berges\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{"Vitesses d\textquotesingle{}ecoulement et leurs valeurs moyennes"}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Vx [m/s]\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}largeur du flux [m]\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlim(}\OperatorTok{{-}}\FloatTok{.5}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (-0.5, 3.0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.legend()}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{PROJET_LSPIV_files/figure-latex/unnamed-chunk-22-1}

\hypertarget{estimation-de-duxe9charge}{%
\subsection*{Estimation de d√©charge}\label{estimation-de-duxe9charge}}
\addcontentsline{toc}{subsection}{Estimation de d√©charge}

Les rejets sont estim√©s en utilisant la m√©thode de la surface de vitesse, en utilisant la formule suivante:

\begin{equation}
Q = \sum_{n=1}^{N} v_n \cdot d_n \cdot b_n
\end{equation}

D'o√π \(v_n\) , \(d_n\), et \(b_n\) sont respectivement la vitesse d'√©coulement, la profondeur et la largeur moyennes en profondeur de la section.

Pour la vitesse d'√©coulement moyenne en profondeur, la vitesse d'√©coulement de surface est multipli√©e par un coefficient d√©termin√© empiriquement \(\alpha\). Ce coefficient est g√©n√©ralement entre \(0.72\) et \(0.95\). Pour l'exemple de vid√©o, le coefficient est estim√© √†
\(0.85\).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# coefficient moyen en profondeur}
\NormalTok{alpha }\OperatorTok{=} \FloatTok{0.85}

\CommentTok{\# sections transversales en largeur}
\NormalTok{step }\OperatorTok{=}\NormalTok{ y\_corrected[}\DecValTok{1}\NormalTok{]}\OperatorTok{{-}}\NormalTok{y\_corrected[}\DecValTok{0}\NormalTok{]}

\CommentTok{\# estimation de d√©bit}
\NormalTok{Q }\OperatorTok{=} \BuiltInTok{sum}\NormalTok{(vx\_mean\_rep }\OperatorTok{*}\NormalTok{ wd  }\OperatorTok{*}\NormalTok{ alpha }\OperatorTok{*}\NormalTok{ step)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Le d√©bit moyen est estim√© √† }\SpecialCharTok{\{\}}\StringTok{ m¬≥/s"}\NormalTok{.}\BuiltInTok{format}\NormalTok{(}\BuiltInTok{round}\NormalTok{(Q, }\DecValTok{2}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Le d√©bit moyen est estim√© √† 3.74 m¬≥/s
\end{verbatim}

\newpage

  \bibliography{LSPIV.bib}

\end{document}
